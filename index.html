<!doctype html>
<html lang="en">

<head>
	<title>Alfredo Budget Report</title>

	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

	<link href="css/main.css" rel="stylesheet">
	<link rel="icon" type="image/x-icon" href="img/favicon.ico">

	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
		crossorigin="anonymous"></script>

	<script src="https://kit.fontawesome.com/ea4954f633.js" crossorigin="anonymous"></script>

  <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
  <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>

	<h2 class="text-center">Alfredo Budget Report</h2>
	<hr />

	<div class="container container-report">
		<div class="row align-items-start">
			<div class="col-6">
				<div class="report overflow-auto" style="max-height: 500px;">
				</div>
			</div>
			<div class="col-6">
				<b>Details</b>
				<div class="details overflow-auto" style="max-height: 474px;"></div>
			</div>
			<div class="col-6">
				<hr />
				<h4 class="text-center">Totals</h4>
				<div class="totals"></div>
			</div>
			<div class="col-6">
				<hr />
				<h4 class="text-center">Incomings</h4>
				<div class="incomings"></div>
			</div>
			<div class="col-12">
				<div id="piechart" style="margin-top: 25px; width: 900px; height: 500px;"></div>
			</div>
		</div>
	</div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"
		integrity="sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA=="
		crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="js/main.js"></script>

	<script>
		if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
			window.location = "index_mob.html"
		}
	</script>

<script type="text/javascript">
  /* exported gapiLoaded */
  /* exported gisLoaded */
  /* exported handleAuthClick */
  /* exported handleSignoutClick */

  // TODO(developer): Set to client ID and API key from the Developer Console
  const CLIENT_ID = '1058634479009-tenrbcqlhuae3hqnrgnlp11tjotap5ao.apps.googleusercontent.com';
  const API_KEY = 'AIzaSyAQtFCqLuNKPSA5_8lHYakulT_qMDn6Mfw';

  // Discovery doc URL for APIs used by the quickstart
  const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';

  // Authorization scopes required by the API; multiple scopes can be
  // included, separated by spaces.
  const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';

  let tokenClient;
  let gapiInited = false;
  let gisInited = false;

  document.getElementById('authorize_button').style.visibility = 'hidden';
  document.getElementById('signout_button').style.visibility = 'hidden';

  /**
   * Callback after api.js is loaded.
   */
  function gapiLoaded() {
    gapi.load('client', intializeGapiClient);
  }

  /**
   * Callback after the API client is loaded. Loads the
   * discovery doc to initialize the API.
   */
  async function intializeGapiClient() {
    await gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs: [DISCOVERY_DOC],
    });
    gapiInited = true;
    maybeEnableButtons();
  }

  /**
   * Callback after Google Identity Services are loaded.
   */
  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: '', // defined later
    });
    gisInited = true;
    maybeEnableButtons();
  }

  /**
   * Enables user interaction after all libraries are loaded.
   */
  function maybeEnableButtons() {
    if (gapiInited && gisInited) {
      document.getElementById('authorize_button').style.visibility = 'visible';
    }
  }

  /**
   *  Sign in the user upon button click.
   */
  function handleAuthClick() {
    tokenClient.callback = async (resp) => {
      if (resp.error !== undefined) {
        throw (resp);
      }
      document.getElementById('signout_button').style.visibility = 'visible';
      document.getElementById('authorize_button').innerText = 'Refresh';
      await readSpreadsheet();
    };

    if (gapi.client.getToken() === null) {
      // Prompt the user to select a Google Account and ask for consent to share their data
      // when establishing a new session.
      tokenClient.requestAccessToken({ prompt: 'consent' });
    } else {
      // Skip display of account chooser and consent dialog for an existing session.
      tokenClient.requestAccessToken({ prompt: '' });
    }
  }

  /**
   *  Sign out the user upon button click.
   */
  function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
      google.accounts.oauth2.revoke(token.access_token);
      gapi.client.setToken('');
      document.getElementById('content').innerText = '';
      document.getElementById('authorize_button').innerText = 'Authorize';
      document.getElementById('signout_button').style.visibility = 'hidden';
    }
  }

  /**
   * Print the names and majors of students in a sample spreadsheet:
   * https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/edit
   */

  async function readSpreadsheet() {

    _bankTransactions = { "data": [] }
    _budget = {
      "data": [],
      "incomings": []
    }

    let _spreadsheetId = '1TEo8hAIiNJi_ZhYV70fC_xfYZDZIAzr30TNVS02Yxlg'

    try {
      let response = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: _spreadsheetId,
        range: 'Lançamentos!A2:D250',
      });
      response.result.values.forEach(element => {
        _bankTransactions.data.push({
          "Data lancamento": element[2],
          "Data valor": element[2],
          "Descricao": element[0] + (element[3] != undefined ? " - " + element[3] : ""),
          "Montante": element[1] != undefined && element[1] != '' ? parseFloatFromCurrency(element[1]) : 0.0,
          "Categoria": element[0],
          "Tipo": "Debito"
        })
      });
    } catch (err) {
      console.log(err)
      document.getElementById('content').innerText = err.message;
    }

    try {
      let response = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: _spreadsheetId,
        range: 'Configuração!A2:B50',
      });
      response.result.values.forEach(element => {
        if (element[0] != undefined&& element.length >= 2) {
          _budget.data.push({
            "desc": element[0],
            "limit": element[1] != undefined && element[1] != '' ? parseFloatFromCurrency(element[1]) : 0.0,
            "fixed_expenses": []
          })
        }
      });
    } catch (err) {
      console.log(err)
      document.getElementById('content').innerText = err.message;
    }

    try {
      let response = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: _spreadsheetId,
        range: 'Despesas Fixas!A2:D50',
      });
      response.result.values.forEach(element => {
        if (element[0] != undefined && element.length >= 3) {

          let category = _budget.data.find(elm => {
            return elm.desc == element[0]
          })

          if (category != undefined) {
            category.fixed_expenses.push({
              "name": element[1],
              "value": element[2] != undefined && element[2] != '' ? parseFloatFromCurrency(element[2]) : 0.0
            })
          }

        }
      });
    } catch (err) {
      console.log(err)
      document.getElementById('content').innerText = err.message;
    }

    try {
      let response = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: _spreadsheetId,
        range: 'Receitas!A2:B25',
      });
      response.result.values.forEach(element => {
        if (element[0] != undefined && element.length >= 2) {
          _budget.incomings.push({
            "name": element[0],
            "value": element[1] != undefined && element[1] != '' ? parseFloatFromCurrency(element[1]) : 0.0,
            "regex": ""
          })
        }
      });
    } catch (err) {
      console.log(err)
      document.getElementById('content').innerText = err.message;
    }

    let _json = await new Transactions(_bankTransactions, _budget).toJSON();
    await console.log(_json)
    buildReport(_json)

  }

  function parseFloatFromCurrency(currency){
    var number = Number(currency.replace(/[^0-9\.-]+/g,""));
    return parseFloat(number)
  }
</script>
<script src="alberto.js"></script>
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

</body>

</html>

