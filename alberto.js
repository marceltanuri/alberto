var _bankTransactions = {
    "data": [
        {
            "Data lancamento": "06-06-2022",
            "Data valor": "06-06-2022",
            "Descricao": "TRF MB WAY P/ *****2647",
            "Montante": "-10.00",
            "Tipo": "Debito",
            "Saldo": "485.11"
        },
        {
            "Data lancamento": "06-06-2022",
            "Data valor": "06-06-2022",
            "Descricao": "COMPRA 3915 LIDL MONTIJO 2870-110 M CONTACTLESS",
            "Montante": "-38.00",
            "Tipo": "Debito",
            "Saldo": "495.11"
        },
        {
            "Data lancamento": "06-06-2022",
            "Data valor": "06-06-2022",
            "Descricao": "COMPRA 3915 PINGO DOCE MONTIJO MONT CONTACTLESS",
            "Montante": "-1.05",
            "Tipo": "Debito",
            "Saldo": "533.11"
        },
        {
            "Data lancamento": "06-06-2022",
            "Data valor": "06-06-2022",
            "Descricao": "COMPRA 3915 PINGO DOCE MONTIJO MONT CONTACTLESS",
            "Montante": "-1.14",
            "Tipo": "Debito",
            "Saldo": "534.16"
        },
        {
            "Data lancamento": "06-06-2022",
            "Data valor": "06-06-2022",
            "Descricao": "COMPRA 3915 PINGO DOCE MONTIJO MONT CONTACTLESS",
            "Montante": "-23.94",
            "Tipo": "Debito",
            "Saldo": "535.30"
        },
        {
            "Data lancamento": "06-06-2022",
            "Data valor": "06-06-2022",
            "Descricao": "LEV ATM 3915 BKINT Montijo       Av Joao XXIII,",
            "Montante": "-10.00",
            "Tipo": "Debito",
            "Saldo": "559.24"
        },
        {
            "Data lancamento": "03-06-2022",
            "Data valor": "03-06-2022",
            "Descricao": "IMPOSTO SELO ART 17.3.4",
            "Montante": "-0.20",
            "Tipo": "Debito",
            "Saldo": "569.24"
        },
        {
            "Data lancamento": "03-06-2022",
            "Data valor": "03-06-2022",
            "Descricao": "COM.MAN.CONTA PACOTE CLIENTE FREQUENTE   052022",
            "Montante": "-5.00",
            "Tipo": "Debito",
            "Saldo": "569.44"
        },
        {
            "Data lancamento": "03-06-2022",
            "Data valor": "03-06-2022",
            "Descricao": "COMPRA 3915 TUTTO CHICCO MONTIJOMON CONTACTLESS",
            "Montante": "-10.78",
            "Tipo": "Debito",
            "Saldo": "574.44"
        },
        {
            "Data lancamento": "03-06-2022",
            "Data valor": "03-06-2022",
            "Descricao": "COMPRA 3915 MCDONALD S MONTIJO      CONTACTLESS",
            "Montante": "-10.05",
            "Tipo": "Debito",
            "Saldo": "585.22"
        },
        {
            "Data lancamento": "03-06-2022",
            "Data valor": "03-06-2022",
            "Descricao": "COMPRA 3915 CONTINENTE 0 -0 MONTIJO CONTACTLESS",
            "Montante": "-25.15",
            "Tipo": "Debito",
            "Saldo": "595.27"
        },
        {
            "Data lancamento": "03-06-2022",
            "Data valor": "03-06-2022",
            "Descricao": "COMPRA 3915 WELL S MONTIJO          CONTACTLESS",
            "Montante": "-6.55",
            "Tipo": "Debito",
            "Saldo": "620.42"
        },
        {
            "Data lancamento": "03-06-2022",
            "Data valor": "03-06-2022",
            "Descricao": "COMPRA 3915 CELEIRO MONTIJO MONTIJO CONTACTLESS",
            "Montante": "-14.65",
            "Tipo": "Debito",
            "Saldo": "626.97"
        },
        {
            "Data lancamento": "03-06-2022",
            "Data valor": "03-06-2022",
            "Descricao": "COMPRA 3915 2BURGER 2870-365 MONTIJ CONTACTLESS",
            "Montante": "-26.90",
            "Tipo": "Debito",
            "Saldo": "641.62"
        },
        {
            "Data lancamento": "02-06-2022",
            "Data valor": "02-06-2022",
            "Descricao": "COMPRA 3915 HARAB S ESFIRRARIA M LISBOA DU",
            "Montante": "-15.10",
            "Tipo": "Debito",
            "Saldo": "668.52"
        },
        {
            "Data lancamento": "02-06-2022",
            "Data valor": "02-06-2022",
            "Descricao": "COMPRA 3915 SUSHI MONTIJO MONTIJO   CONTACTLESS",
            "Montante": "-29.25",
            "Tipo": "Debito",
            "Saldo": "683.62"
        },
        {
            "Data lancamento": "01-06-2022",
            "Data valor": "01-06-2022",
            "Descricao": "COMPRA 3915 LIDL MONTIJO 2870-110 M CONTACTLESS",
            "Montante": "-13.11",
            "Tipo": "Debito",
            "Saldo": "712.87"
        },
        {
            "Data lancamento": "01-06-2022",
            "Data valor": "01-06-2022",
            "Descricao": "COMPRA 3915 DECATHLON AMADORA",
            "Montante": "-31.50",
            "Tipo": "Debito",
            "Saldo": "725.98"
        },
        {
            "Data lancamento": "01-06-2022",
            "Data valor": "01-06-2022",
            "Descricao": "TRF P/ Antonio Luis Correia Natal Maldonado Pir",
            "Montante": "-780.00",
            "Tipo": "Debito",
            "Saldo": "757.48"
        },
        {
            "Data lancamento": "31-05-2022",
            "Data valor": "31-05-2022",
            "Descricao": "TRF MB WAY P/ *****7226",
            "Montante": "-29.00",
            "Tipo": "Debito",
            "Saldo": "1537.48"
        },
        {
            "Data lancamento": "31-05-2022",
            "Data valor": "31-05-2022",
            "Descricao": "COMPRA 3915 WEEEL VASCO DA GAMA LIS CONTACTLESS",
            "Montante": "-3.60",
            "Tipo": "Debito",
            "Saldo": "1566.48"
        },
        {
            "Data lancamento": "31-05-2022",
            "Data valor": "31-05-2022",
            "Descricao": "COMPRA 3915 M 16-RESTAURANTES RALIS CONTACTLESS",
            "Montante": "-5.10",
            "Tipo": "Debito",
            "Saldo": "1570.08"
        },
        {
            "Data lancamento": "31-05-2022",
            "Data valor": "31-05-2022",
            "Descricao": "COMPRA 3915 ORIENTE LISBOA          CONTACTLESS",
            "Montante": "-5.00",
            "Tipo": "Debito",
            "Saldo": "1575.18"
        },
        {
            "Data lancamento": "31-05-2022",
            "Data valor": "31-05-2022",
            "Descricao": "COMPRA 3915 ORIENTE LISBOA          CONTACTLESS",
            "Montante": "-10.00",
            "Tipo": "Debito",
            "Saldo": "1580.18"
        },
        {
            "Data lancamento": "31-05-2022",
            "Data valor": "31-05-2022",
            "Descricao": "LEV ATM 3915 BKINT Montijo       Av Joao XXIII,",
            "Montante": "-20.00",
            "Tipo": "Debito",
            "Saldo": "1590.18"
        },
        {
            "Data lancamento": "30-05-2022",
            "Data valor": "30-05-2022",
            "Descricao": "TRF MB WAY P/ *****2647",
            "Montante": "-5.00",
            "Tipo": "Debito",
            "Saldo": "1610.18"
        },
        {
            "Data lancamento": "30-05-2022",
            "Data valor": "30-05-2022",
            "Descricao": "DD PT34100781 EDP COMERCIAL-C 16010011508882",
            "Montante": "-7.90",
            "Tipo": "Debito",
            "Saldo": "1615.18"
        },
        {
            "Data lancamento": "30-05-2022",
            "Data valor": "30-05-2022",
            "Descricao": "LEV ATM 3915 BTA   MONTIJO       Pr Republica,",
            "Montante": "-10.00",
            "Tipo": "Debito",
            "Saldo": "1623.08"
        },
        {
            "Data lancamento": "30-05-2022",
            "Data valor": "30-05-2022",
            "Descricao": "TRF MB WAY P/ *****0976",
            "Montante": "-6.00",
            "Tipo": "Debito",
            "Saldo": "1633.08"
        },
        {
            "Data lancamento": "30-05-2022",
            "Data valor": "30-05-2022",
            "Descricao": "TRF MB WAY P/ *****9542",
            "Montante": "-11.95",
            "Tipo": "Debito",
            "Saldo": "1639.08"
        },
        {
            "Data lancamento": "27-05-2022",
            "Data valor": "27-05-2022",
            "Descricao": "COMPRA 3915 HARAB S ESFIRRARIA M LISBOA DU",
            "Montante": "-17.30",
            "Tipo": "Debito",
            "Saldo": "1651.03"
        },
        {
            "Data lancamento": "27-05-2022",
            "Data valor": "27-05-2022",
            "Descricao": "COMPRA 3915 FARMACIA CORVO 2870-225 MONTIJO",
            "Montante": "-13.68",
            "Tipo": "Debito",
            "Saldo": "1668.33"
        },
        {
            "Data lancamento": "25-05-2022",
            "Data valor": "25-05-2022",
            "Descricao": "MBW 3915 PAG-ESTADO      000000000000000",
            "Montante": "-126.30",
            "Tipo": "Debito",
            "Saldo": "1682.01"
        },
        {
            "Data lancamento": "25-05-2022",
            "Data valor": "25-05-2022",
            "Descricao": "COMPRA 3915 PAYPAL UBERPAYMENT 35314369001 NL",
            "Montante": "-5.56",
            "Tipo": "Debito",
            "Saldo": "1808.31"
        },
        {
            "Data lancamento": "25-05-2022",
            "Data valor": "25-05-2022",
            "Descricao": "COMPRA 3915 PAYPAL UBERPAYMENT 35314369001 NL",
            "Montante": "-4.82",
            "Tipo": "Debito",
            "Saldo": "1813.87"
        },
        {
            "Data lancamento": "23-05-2022",
            "Data valor": "23-05-2022",
            "Descricao": "TRANSFERENCIA - VENCIMENTO",
            "Montante": "1610.53",
            "Tipo": "Credito",
            "Saldo": "1818.69"
        },
        {
            "Data lancamento": "23-05-2022",
            "Data valor": "23-05-2022",
            "Descricao": "COMPRA 3915 CONTINENTE 0 -0 MONTIJO CONTACTLESS",
            "Montante": "-0.30",
            "Tipo": "Debito",
            "Saldo": "208.16"
        },
        {
            "Data lancamento": "23-05-2022",
            "Data valor": "23-05-2022",
            "Descricao": "COMPRA 3915 CONTINENTE 0 -0 MONTIJO CONTACTLESS",
            "Montante": "-52.43",
            "Tipo": "Debito",
            "Saldo": "208.46"
        },
        {
            "Data lancamento": "23-05-2022",
            "Data valor": "23-05-2022",
            "Descricao": "COMPRA 3915 NOS CINEMAS F MONTIJMON CONTACTLESS",
            "Montante": "-4.50",
            "Tipo": "Debito",
            "Saldo": "260.89"
        },
        {
            "Data lancamento": "23-05-2022",
            "Data valor": "23-05-2022",
            "Descricao": "COMPRA 3915 CONTINENTE 0 -0 MONTIJO CONTACTLESS",
            "Montante": "-2.09",
            "Tipo": "Debito",
            "Saldo": "265.39"
        },
        {
            "Data lancamento": "23-05-2022",
            "Data valor": "23-05-2022",
            "Descricao": "COMPRA 3915 VERDE PRINCIPAL UNIPMONTIJO",
            "Montante": "-18.75",
            "Tipo": "Debito",
            "Saldo": "267.48"
        },
        {
            "Data lancamento": "23-05-2022",
            "Data valor": "23-05-2022",
            "Descricao": "COMPRA 3915 MBWAY - CINEMAS 1600-404 LISBOA",
            "Montante": "-7.05",
            "Tipo": "Debito",
            "Saldo": "286.23"
        },
        {
            "Data lancamento": "20-05-2022",
            "Data valor": "20-05-2022",
            "Descricao": "COMPRA 3915 PINGO DOCE MONTIJO MONT CONTACTLESS",
            "Montante": "-23.31",
            "Tipo": "Debito",
            "Saldo": "293.28"
        },
        {
            "Data lancamento": "20-05-2022",
            "Data valor": "20-05-2022",
            "Descricao": "COMPRA 3915 FARMACIA CORVO 2870-225 MONTIJO",
            "Montante": "-2.41",
            "Tipo": "Debito",
            "Saldo": "316.59"
        },
        {
            "Data lancamento": "20-05-2022",
            "Data valor": "20-05-2022",
            "Descricao": "COMPRA 3915 SUSHI MONTIJO MONTIJO   CONTACTLESS",
            "Montante": "-34.05",
            "Tipo": "Debito",
            "Saldo": "319.00"
        },
        {
            "Data lancamento": "19-05-2022",
            "Data valor": "19-05-2022",
            "Descricao": "COMPRA 3915 DECATHLON AMADORA",
            "Montante": "-23.95",
            "Tipo": "Debito",
            "Saldo": "353.05"
        },
        {
            "Data lancamento": "19-05-2022",
            "Data valor": "19-05-2022",
            "Descricao": "DD PT20100839 NOS Comunicacoe 06463366868",
            "Montante": "-61.99",
            "Tipo": "Debito",
            "Saldo": "377.00"
        },
        {
            "Data lancamento": "19-05-2022",
            "Data valor": "19-05-2022",
            "Descricao": "COMPRA 3915 LIDL MONTIJO 2870-110 MONTIJO",
            "Montante": "-23.36",
            "Tipo": "Debito",
            "Saldo": "438.99"
        },
        {
            "Data lancamento": "18-05-2022",
            "Data valor": "18-05-2022",
            "Descricao": "TRF MB WAY P/ *****9980",
            "Montante": "-3.50",
            "Tipo": "Debito",
            "Saldo": "462.35"
        },
        {
            "Data lancamento": "18-05-2022",
            "Data valor": "18-05-2022",
            "Descricao": "COMPRA 3915 IFTHENPAY S M LAMAS",
            "Montante": "-15.80",
            "Tipo": "Debito",
            "Saldo": "465.85"
        },
        {
            "Data lancamento": "17-05-2022",
            "Data valor": "17-05-2022",
            "Descricao": "COMPRA 3915 LIDL MONTIJO 2870-110 M CONTACTLESS",
            "Montante": "-21.14",
            "Tipo": "Debito",
            "Saldo": "481.65"
        },
        {
            "Data lancamento": "17-05-2022",
            "Data valor": "17-05-2022",
            "Descricao": "TRF. P/O  GFI PORTUGAL TECNOLOGIAS IN",
            "Montante": "502.00",
            "Tipo": "Credito",
            "Saldo": "502.79"
        },
        {
            "Data lancamento": "16-05-2022",
            "Data valor": "16-05-2022",
            "Descricao": "COMPRA 3915 LIDL MONTIJO 2870-110 M CONTACTLESS",
            "Montante": "-3.33",
            "Tipo": "Debito",
            "Saldo": "0.79"
        },
        {
            "Data lancamento": "16-05-2022",
            "Data valor": "16-05-2022",
            "Descricao": "COMPRA 3915 LIDL MONTIJO 2870-110 M CONTACTLESS",
            "Montante": "-8.25",
            "Tipo": "Debito",
            "Saldo": "4.12"
        },
        {
            "Data lancamento": "O millenniumbcp.pt e um servico do Banco Comercial Portugues S.A."
        }
    ]
}

var _budget = {
    "data": [
        {
            "desc": "Mercado",
            "limit": 400,
            "regex": [
                "PINGO DOCE",
                "O PAO DA MAE",
                "CONTINENTE",
                "LIDL",
                "TALHO"
            ]
        },
        {
            "desc": "TakeAway",
            "limit": 100,
            "regex": [
                "CAFETARIA BRAZIL",
                "PAYPAL GLOVO",
                "PAYPAL PMNTSBVEATS",
                "JERONYMO ALMADA",
                "BURGER KING",
                "BATIKANOS",
                "CAFETARIA",
                "SUSHI",
                "MCD ",
                "LOS TAKITOS",
                "MCDONALD",
                "BAGGA",
                "2BURGER",
                "GAYA GELATO",
                "HARABS ESFIRRARIA",
                "HARAB S ESFIRRARIA",
                "TACO BELL",
                "STARBUCKS",
                "GIORNO",
                "CPPB - ",
                "IFTHENPAY S M LAMAS",
                "TRF MB WAY P/ *****9980",
                "TRF MB WAY P/ *****9542"
            ]
        },
        {
            "desc": "Transportes",
            "limit": 60,
            "regex": [
                "BAIXA CHIADO LISBOA",
                "SERVICO GALP",
                "UBERPAYMENT",
                "SERVICO REBOLA E FILHO",
                "SERVICO REPSOL",
                "TT TRANSTEJO",
                "TERMINAL FLUVIAL",
                "Barreiro      Hosp Distrital",
                "PETROROTUNDA",
                "TRANSTEJO",
                "ORIENTE LISBOA"
            ]
        },
        {
            "desc": "Lazer",
            "limit": 50,
            "regex": [
                "CINEMAS",
                "snooker",
                "*****6382",
                "KOTO MONTIJO",
                "TICKET LINE",
                "LEV ATM 3915 BTA MONTIJO Pr Republica",
                "TRF MB WAY P/ *****0976"
            ]
        },
        {
            "desc": "Farmacia",
            "limit": 20,
            "regex": [
                "FARMACIA",
                "FARM UN MUT",
                "WELL S MONTIJO"
            ]
        },
        {
            "desc": "Moradia",
            "regex": [
                "NOS Comunicacoe",
                "EDP COMERCIAL",
                "Antonio Luis Correia Natal Maldonado",
                "PAG SERV 21557"
            ],
            "fixed_expenses": [
                {
                    "name": "edp",
                    "value": 70.71
                },
                {
                    "name": "TRF apto",
                    "value": 780
                },
                {
                    "name": "edp inspecao",
                    "value": 7.90
                },
                {
                    "name": "agua CTT",
                    "value": 41.30
                },
                {
                    "name": "tv_net nos",
                    "value": 61.99
                }
            ]
        },
        {
            "desc": "Compras",
            "limit": 50,
            "regex": [
                "LEV ATM 3915 BKINT Montijo",
                "LEFTIES",
                "PRIMARK",
                "COMPRA 3915 CTT",
                "FNAC",
                "DECATHLON",
                "VERDE PRINCIPAL UNIPMONTIJO",
                "CELEIRO MONTIJO",
                "TUTTO CHICCO"
            ]
        },
        {
            "desc": "Prestacoes",
            "fixed_expenses": [
                {
                    "name": "doula Adriana",
                    "value": 100
                },
                {
                    "name": "iva Estado",
                    "value": 126.30
                },
                {
                    "name": "BR Estrangeiro",
                    "value": 0
                }
            ],
            "regex": [
                "TRF P/ Adriana",
                "PAG-ESTADO",
                "Ordem Pagamento s/Estrangeiro"
            ]
        }
    ],
    "incomings": [
        {
            "name": "ticket",
            "value": 133,
            "regex": "CARREGAMENTO"
        },
        {
            "name": "ajuda de custo",
            "value": 502,
            "regex": "TRF. P/O  GFI PORTUGAL TECNOLOGIAS IN"
        },
        {
            "name": "salÃ¡rio",
            "value": 1610.53,
            "regex": "TRANSFERENCIA - VENCIMENTO"
        },
        {
            "name": "abono",
            "value": 97,
            "regex": "abono pre natal"
        }
    ]
}

class Transactions {
    constructor(bankTransactions, budget) {


        var all_transactions = []

        // bank balance
        this.balance = bankTransactions.data[0].Saldo

        all_transactions = bankTransactions.data

        // incomings
        this.estimatedIncomings = budget.incomings
        this.incomings = []

        // load expensesGroup based on budget data
        this.expensesGroup = []
        budget.data.forEach(cat => {
            this.expensesGroup.push(new ExpenseGroup(cat))
        })

        // adds a default group for non categorized transactions
        this.expensesGroup.push(new ExpenseGroup({
            "desc": "Outros",
            "limit": 0.001,
            "default": true,
            "regex": []
        }))

        // populates expensesGroup with transactions from json (bank & ticket)
        all_transactions.filter(transaction => transaction.Tipo === "Debito").forEach(debtTransaction => {
            this.addExpenseToExpenseGroupUsingExpDescriptionAndGroupRegexConfig(debtTransaction.Categoria, debtTransaction.Descricao, debtTransaction["Data lancamento"], debtTransaction.Montante)
        })

        all_transactions.filter(transaction => transaction.Tipo === "Credito").forEach(creditTransaction => {
            this.addIncoming(creditTransaction.Descricao, creditTransaction["Data lancamento"], creditTransaction.Montante)
        })
    }

    getIncomingsSum() {
        let sum = 0
        this.incomings.forEach(incoming => {
            sum += parseFloat(incoming.value)
        })

        // reads estimatedIncomings and even if it's not paid yet its value is considered in the sum
        this.getEstimatedIncomings().forEach(estimatedIncoming => {
            if (!estimatedIncoming.paid) {
                sum += estimatedIncoming.value
            }
        })

        return sum
    }

    /**
     * 
     * @returns Incomings sorted by date
     */
    getIncomings() {
        const sortedIncomings = this.incomings.slice().sort((a, b) => (new Date(a.date.replace(/(\d{2})-(\d{2})-(\d{4})/, "$2/$1/$3")) - new Date(b.date.replace(/(\d{2})-(\d{2})-(\d{4})/, "$2/$1/$3"))))
        return sortedIncomings
    }

    /**
     * Adds the expense the correct expenseGroup based on expense description
     * @param {*} description 
     * @param {*} date 
     * @param {*} value 
     */
    addExpenseToExpenseGroupUsingExpDescriptionAndGroupRegexConfig(category, description, date, value) {

        let expenseGroup = this.expensesGroup.find(_expenseGroup => {
            return _expenseGroup.name == category
        })

        if (expenseGroup == null) {
            expenseGroup = this.expensesGroup.find(_expenseGroup => {
                return _expenseGroup.default === true
            })
        }

        if (expenseGroup != null) {
            expenseGroup.addExpense(description, date, value)
        }
    }

    addIncoming(description, date, value) {
        this.incomings.push(new Incoming(description, date, value))
    }

    getGroupAvailableValueSum() {
        let sum = 0.0
        this.expensesGroup.forEach(elm => {
            let avl = elm.getAvailableValue()
            if (avl > 0) {
                sum += avl
            }
        })
        return sum;
    }

    getGroupExpensesSum() {
        let sum = 0.0
        this.expensesGroup.forEach(elm => {
            sum = sum + elm.getExpensesSum()
        })
        return sum;
    }

    getTotalSaved() {
        let totalSaved = parseFloat(this.balance)

        if (this.ticketBalance != "") {
            totalSaved += parseFloat(this.ticketBalance)
        }

        totalSaved -= (this.getGroupAvailableValueSum())

        return totalSaved
    }

    getTotalBalance() {
        let sum = 0.0

        if (this.balance != "")
            sum += parseFloat(this.balance)

        if (this.ticketBalance != "")
            sum += parseFloat(this.ticketBalance)

        return sum
    }

    getLimitSum() {
        let sum = 0.0
        this.expensesGroup.forEach(elm => { sum += parseFloat(elm.limit) })
        return sum
    }

    getEstimatedIncomings() {

        this.estimatedIncomings.forEach(estimatedIncoming => {
            estimatedIncoming.paid = (this.incomings.some(incoming => {
                return incoming.description.includes(estimatedIncoming.regex)
            }))
        })

        return this.estimatedIncomings

    }

    toJSON() {
        var formatter = new Intl.NumberFormat('pt-PT', {
            style: 'currency',
            currency: 'EUR',
        });

        let json = {}

        json.expensesGroup = []

        this.expensesGroup.forEach(expenseGroup => {
            let _expenseGroup = expenseGroup
            _expenseGroup.availableValue = expenseGroup.getAvailableValue()
            _expenseGroup.expensesSum = expenseGroup.getExpensesSum()
            _expenseGroup.expenseSumPercentage = expenseGroup.getExpenseSumPercentage()
            _expenseGroup.availableValuePercentage = expenseGroup.getAvailableValuePercentage()
            _expenseGroup.expenses = expenseGroup.getExpenses()
            _expenseGroup.fixedExpenses = expenseGroup.getFixedExpenses()
            json.expensesGroup.push(_expenseGroup)
        })

        json.totals = {}

        json.totals.balance = formatter.format(this.getTotalBalance())
        json.totals.pendingExpenses = formatter.format(this.getGroupAvailableValueSum())
        json.totals.available = formatter.format(this.getIncomingsSum() - (this.getGroupAvailableValueSum() - this.getGroupExpensesSum()))
        json.totals.gross = formatter.format(this.getGroupExpensesSum())
        json.totals.previewedExpenses = formatter.format(this.getLimitSum())
        json.totals.realExpenses = formatter.format(this.getGroupAvailableValueSum() - this.getGroupExpensesSum())

        json.totals.cc = formatter.format(this.balance)

        if (this.ticketBalance != "") {
            json.totals.ticket = formatter.format(this.ticketBalance)
        }

        json.incomings = {}
        json.estimatedIncomings = this.getEstimatedIncomings()
        json.incomings.data = this.getIncomings()
        json.incomings.sum = formatter.format(this.getIncomingsSum())

        return json
    }
}

class ExpenseGroup {
    constructor(cat) {
        this.name = cat.desc
        this.default = cat.default
        this.regex = cat.regex
        if (cat.limit != undefined)
            this.limit = cat.limit
        if (cat.fixed_expenses != undefined) {
            this.fixedExpenses = cat.fixed_expenses
            let limit = 0
            cat.fixed_expenses.forEach(exp => {
                limit += parseFloat(exp.value)
            })
            this.limit = limit
        }

        this.expenses = []
    }

    addExpense(desc, date, value) {
        this.expenses.push(new Expense(this.name, desc, date, value))
    }

    /**
     * 
     * @returns FixedExpenses enhanced list containing the boolean value isPaid
     */
    getFixedExpenses() {
        if (this.fixedExpenses != undefined) {
            let _fixedExpenses = this.fixedExpenses
            _fixedExpenses.forEach(fixexp => {
                fixexp.paid = this.isFixedExpensePaid(fixexp)
            })
            return _fixedExpenses
        }
    }

    /**
     * 
     * @param {*} fixedExpense 
     * @returns true if FixedExpense value is equals to any expense value and at least one word of FixedExpense name is found in any expense description.
     */
    isFixedExpensePaid(fixedExpense) {

        this.expenses.filter(exp => {
            return exp.value == (fixedExpense.value * -1)
        })

        let _paid = false
        this.expenses.forEach(exp => {
            if (exp.value == (fixedExpense.value * -1)) {
                let _words = fixedExpense.name.toLowerCase().split(" ")
                _words.forEach(word => {
                    if (exp.description.toLowerCase().includes(word.toLowerCase())) {
                        _paid = true
                        return _paid
                    }
                })
            }
        })
        return _paid
    }

    getExpensesSum() {
        let sum = 0.0
        this.expenses.forEach(elm => { sum = sum + parseFloat(elm.value) })
        return sum
    }

    getExpenseSumPercentage() {
        return Math.round((this.getExpensesSum() * -1) / this.limit * 100).toPrecision(3)
    }

    getAvailableValuePercentage() {
        return Math.round(100 - (this.getExpensesSum() * -1) / this.limit * 100).toPrecision(3)
    }

    // returns expenses list sorted by date
    getExpenses() {
        const sortedExpeneses = this.expenses.slice().sort((a, b) => (new Date(a.date.replace(/(\d{2})-(\d{2})-(\d{4})/, "$2/$1/$3")) - new Date(b.date.replace(/(\d{2})-(\d{2})-(\d{4})/, "$2/$1/$3"))))
        return sortedExpeneses
    }

    getAvailableValue() {
        return parseFloat(this.limit) + this.getExpensesSum()
    }
}
class Expense {
    constructor(group, description, date, value) {
        this.group = group
        this.description = description
        this.date = date
        this.value = value
    }
}

class Incoming {
    constructor(description, date, value) {
        this.description = description
        this.date = date
        this.value = value
    }
}

console.log(new Transactions(_bankTransactions, _budget).toJSON())